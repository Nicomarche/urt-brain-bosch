<div class="line-following-config">
  <div class="header">
    <h3>Configuraci√≥n de Seguimiento de L√≠nea</h3>
    <button class="btn-reset" (click)="resetDefaults()">Restaurar Valores</button>
  </div>

  <!-- AI Analysis Window -->
  <div class="ai-analysis-panel" *ngIf="debugStreamEnabled">
    <div class="ai-header">
      <h4>An√°lisis en Tiempo Real</h4>
      <div class="ai-indicators">
        <span class="indicator" [class.active]="debugStatus?.active">
          {{ debugStatus?.active ? 'ACTIVO' : 'INACTIVO' }}
        </span>
        <span class="indicator mode-indicator">{{ getModeDisplayName() }}</span>
      </div>
    </div>
    
    <div class="ai-content">
      <div class="ai-video-container">
        <img [src]="debugImageSrc" *ngIf="debugImageSrc" alt="Debug View" class="ai-video"/>
        <div class="no-stream" *ngIf="!debugImageSrc">
          <div class="no-stream-icon">üì∑</div>
          <p>Esperando stream de video...</p>
          <p class="hint">Selecciona una vista de debug para comenzar</p>
        </div>
      </div>
      
      <div class="ai-stats">
        <div class="stat-item">
          <span class="stat-label">Vista</span>
          <span class="stat-value">{{ debugViewName }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Direcci√≥n</span>
          <span class="stat-value">{{ debugStatus?.steering !== null ? (debugStatus?.steering | number:'1.1-1') + '¬∞' : '--' }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Velocidad</span>
          <span class="stat-value">{{ debugStatus?.speed ?? '--' }}</span>
        </div>
        <div class="stat-item" *ngIf="selectedMode !== 'hybridnets'">
          <span class="stat-label">LSTR</span>
          <span class="stat-value" [class.available]="debugStatus?.lstr_available">
            {{ debugStatus?.lstr_available ? 'Disponible' : 'No disponible' }}
          </span>
        </div>
        <div class="stat-item" *ngIf="selectedMode === 'hybridnets'">
          <span class="stat-label">Servidor</span>
          <span class="stat-value" [class.available]="hybridnetsConnected">
            {{ hybridnetsConnected ? hybridnetsRoundtripMs.toFixed(0) + 'ms' : 'Desconectado' }}
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Detection Mode Selection -->
  <div class="config-section">
    <div class="section-header">
      <h4>Modo de Detecci√≥n</h4>
    </div>
    <div class="button-group mode-buttons">
      <button 
        class="mode-btn" 
        [class.selected]="selectedMode === 'opencv'"
        (click)="setMode('opencv')">
        <span class="mode-icon">üëÅÔ∏è</span>
        <span class="mode-name">OpenCV</span>
        <span class="mode-desc">Detecci√≥n cl√°sica con visi√≥n por computadora. Usa m√°scaras HSV y transformaciones geom√©tricas.</span>
      </button>
      <button 
        class="mode-btn" 
        [class.selected]="selectedMode === 'lstr'"
        (click)="setMode('lstr')"
        [disabled]="!lstrAvailable">
        <span class="mode-icon">ü§ñ</span>
        <span class="mode-name">LSTR AI</span>
        <span class="mode-desc">Red neuronal LSTR para detecci√≥n de carriles. M√°s preciso pero requiere m√°s recursos.</span>
        <span class="mode-badge" *ngIf="!lstrAvailable">No disponible</span>
      </button>
      <button 
        class="mode-btn" 
        [class.selected]="selectedMode === 'hybrid'"
        (click)="setMode('hybrid')"
        [disabled]="!lstrAvailable">
        <span class="mode-icon">‚ö°</span>
        <span class="mode-name">H√≠brido</span>
        <span class="mode-desc">Combina OpenCV y LSTR. Usa IA cuando est√° disponible, fallback a OpenCV si falla.</span>
        <span class="mode-badge" *ngIf="!lstrAvailable">No disponible</span>
      </button>
      <button 
        class="mode-btn hybridnets-btn" 
        [class.selected]="selectedMode === 'hybridnets'"
        (click)="setMode('hybridnets')">
        <span class="mode-icon">üåê</span>
        <span class="mode-name">HybridNets</span>
        <span class="mode-desc">Red neuronal en servidor remoto con GPU. Env√≠a frames por red, m√°xima precisi√≥n.</span>
        <span class="mode-badge server-badge" *ngIf="selectedMode === 'hybridnets'">
          {{ hybridnetsConnected ? 'Conectado' : 'Desconectado' }}
        </span>
      </button>
    </div>
  </div>

  <!-- HybridNets Server Configuration -->
  <div class="config-section hybridnets-config" *ngIf="selectedMode === 'hybridnets'">
    <div class="section-header">
      <h4>Servidor HybridNets</h4>
      <span class="connection-status" [class.connected]="hybridnetsConnected">
        {{ hybridnetsConnected ? 'Conectado' : 'Desconectado' }}
      </span>
    </div>

    <div class="server-url-row">
      <label>URL del servidor</label>
      <input type="text" class="server-url-input" 
             [(ngModel)]="hybridnetsServerUrl" 
             (change)="setHybridnetsServerUrl(hybridnetsServerUrl)"
             placeholder="ws://192.168.1.100:8500/ws/steering"/>
    </div>

    <div class="server-info-grid">
      <div class="server-info-item">
        <span class="info-label">Endpoint</span>
        <div class="btn-group-small">
          <button [class.selected]="hybridnetsServerUrl.endsWith('/ws/steering')"
                  (click)="setHybridnetsEndpoint('/ws/steering')">
            Steering
          </button>
          <button [class.selected]="hybridnetsServerUrl.endsWith('/ws/inference')"
                  (click)="setHybridnetsEndpoint('/ws/inference')">
            Completo
          </button>
        </div>
      </div>
      <div class="server-info-item">
        <span class="info-label">Calidad JPEG</span>
        <div class="btn-group-small">
          <button *ngFor="let q of [40, 55, 70, 85]"
                  [class.selected]="hybridnetsJpegQuality === q"
                  (click)="setHybridnetsJpegQuality(q)">{{ q }}%</button>
        </div>
      </div>
      <div class="server-info-item">
        <span class="info-label">Timeout (s)</span>
        <div class="btn-group-small">
          <button *ngFor="let t of [0.5, 1.0, 2.0, 5.0]"
                  [class.selected]="hybridnetsTimeout === t"
                  (click)="setHybridnetsTimeout(t)">{{ t }}s</button>
        </div>
      </div>
    </div>

    <div class="server-stats" *ngIf="hybridnetsConnected">
      <div class="server-stat">
        <span class="stat-label">Roundtrip</span>
        <span class="stat-value" [class.good]="hybridnetsRoundtripMs < 50" [class.warn]="hybridnetsRoundtripMs >= 50 && hybridnetsRoundtripMs < 100" [class.bad]="hybridnetsRoundtripMs >= 100">
          {{ hybridnetsRoundtripMs | number:'1.0-0' }}ms
        </span>
      </div>
      <div class="server-stat">
        <span class="stat-label">Server FPS</span>
        <span class="stat-value">{{ hybridnetsServerFps | number:'1.0-0' }}</span>
      </div>
    </div>

    <p class="hybridnets-hint">
      El servidor debe estar corriendo <code>python server.py</code> en una m√°quina con GPU.
      Conecta ambos dispositivos a la misma red local.
    </p>
  </div>

  <!-- LSTR Model Selection -->
  <div class="config-section" *ngIf="selectedMode === 'lstr' || selectedMode === 'hybrid'">
    <div class="section-header">
      <h4>Modelo LSTR</h4>
    </div>
    <div class="button-group model-buttons">
      <button 
        *ngFor="let model of lstrModels"
        class="model-btn" 
        [class.selected]="selectedLstrModel === model.id"
        (click)="setLstrModel(model.id)">
        <span class="model-name">{{ model.name }}</span>
        <span class="model-resolution">{{ model.resolution }}</span>
        <span class="model-speed">{{ model.speed }}</span>
      </button>
    </div>
  </div>

  <!-- Debug View Selection -->
  <div class="config-section">
    <div class="section-header">
      <h4>Vista de Debug</h4>
    </div>
    <div class="button-group view-buttons">
      <button 
        *ngFor="let view of debugViews"
        class="view-btn" 
        [class.selected]="selectedDebugView === view.id"
        (click)="setDebugView(view.id)">
        <span class="view-icon">{{ view.icon }}</span>
        <span class="view-name">{{ view.name }}</span>
      </button>
    </div>
    <p class="view-description" *ngIf="getSelectedViewDescription()">
      {{ getSelectedViewDescription() }}
    </p>
  </div>

  <!-- Stream Settings -->
  <div class="config-section compact">
    <div class="section-header">
      <h4>Configuraci√≥n del Stream</h4>
    </div>
    <div class="inline-controls">
      <div class="control-item">
        <label>FPS</label>
        <div class="btn-group-small">
          <button *ngFor="let fps of [1, 5, 10, 15]" 
                  [class.selected]="streamFps === fps"
                  (click)="setStreamFps(fps)">{{ fps }}</button>
        </div>
      </div>
      <div class="control-item">
        <label>Calidad</label>
        <div class="btn-group-small">
          <button *ngFor="let q of [30, 50, 70, 90]" 
                  [class.selected]="streamQuality === q"
                  (click)="setStreamQuality(q)">{{ q }}%</button>
        </div>
      </div>
      <div class="control-item">
        <label>Escala</label>
        <div class="btn-group-small">
          <button *ngFor="let s of [0.25, 0.5, 0.75, 1.0]" 
                  [class.selected]="streamScale === s"
                  (click)="setStreamScale(s)">{{ s * 100 }}%</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Collapsible Parameter Groups -->
  <div class="config-section">
    <div class="section-header clickable" (click)="toggleSection('speed')">
      <h4>üöó Velocidad</h4>
      <span class="toggle-icon">{{ expandedSections['speed'] ? '‚ñº' : '‚ñ∂' }}</span>
    </div>
    <div class="slider-content" *ngIf="expandedSections['speed']">
      <div class="slider-row" *ngFor="let slider of getSlidersByGroup('speed')">
        <label>{{ slider.label }}</label>
        <input type="range" [min]="slider.min" [max]="slider.max" [step]="slider.step"
               [(ngModel)]="slider.value" (input)="onSliderChange(slider)"/>
        <span class="value">{{ slider.value }}</span>
      </div>
    </div>
  </div>

  <div class="config-section">
    <div class="section-header clickable" (click)="toggleSection('pid')">
      <h4>üéØ Control PID</h4>
      <span class="toggle-icon">{{ expandedSections['pid'] ? '‚ñº' : '‚ñ∂' }}</span>
    </div>
    <div class="slider-content" *ngIf="expandedSections['pid']">
      <div class="slider-row" *ngFor="let slider of getSlidersByGroup('pid')">
        <label>{{ slider.label }}</label>
        <input type="range" [min]="slider.min" [max]="slider.max" [step]="slider.step"
               [(ngModel)]="slider.value" (input)="onSliderChange(slider)"/>
        <span class="value">{{ slider.value }}</span>
      </div>
    </div>
  </div>

  <div class="config-section">
    <div class="section-header clickable" (click)="toggleSection('roi')">
      <h4>üìê Regi√≥n de Inter√©s (ROI)</h4>
      <span class="toggle-icon">{{ expandedSections['roi'] ? '‚ñº' : '‚ñ∂' }}</span>
    </div>
    <div class="slider-content" *ngIf="expandedSections['roi']">
      <div class="slider-row" *ngFor="let slider of getSlidersByGroup('roi')">
        <label>{{ slider.label }}</label>
        <input type="range" [min]="slider.min" [max]="slider.max" [step]="slider.step"
               [(ngModel)]="slider.value" (input)="onSliderChange(slider)"/>
        <span class="value">{{ slider.value }}</span>
      </div>
    </div>
  </div>

  <div class="config-section">
    <div class="section-header clickable" (click)="toggleSection('white')">
      <h4>‚ö™ L√≠nea Blanca (HSV)</h4>
      <span class="toggle-icon">{{ expandedSections['white'] ? '‚ñº' : '‚ñ∂' }}</span>
    </div>
    <div class="slider-content" *ngIf="expandedSections['white']">
      <div class="slider-row" *ngFor="let slider of getSlidersByGroup('white')">
        <label>{{ slider.label }}</label>
        <input type="range" [min]="slider.min" [max]="slider.max" [step]="slider.step"
               [(ngModel)]="slider.value" (input)="onSliderChange(slider)"/>
        <span class="value">{{ slider.value }}</span>
      </div>
    </div>
  </div>

  <div class="config-section">
    <div class="section-header clickable" (click)="toggleSection('yellow')">
      <h4>üü° L√≠nea Amarilla (HSV)</h4>
      <span class="toggle-icon">{{ expandedSections['yellow'] ? '‚ñº' : '‚ñ∂' }}</span>
    </div>
    <div class="slider-content" *ngIf="expandedSections['yellow']">
      <div class="slider-row" *ngFor="let slider of getSlidersByGroup('yellow')">
        <label>{{ slider.label }}</label>
        <input type="range" [min]="slider.min" [max]="slider.max" [step]="slider.step"
               [(ngModel)]="slider.value" (input)="onSliderChange(slider)"/>
        <span class="value">{{ slider.value }}</span>
      </div>
    </div>
  </div>

  <div class="config-section">
    <div class="section-header clickable" (click)="toggleSection('image')">
      <h4>üîß Procesamiento de Imagen</h4>
      <span class="toggle-icon">{{ expandedSections['image'] ? '‚ñº' : '‚ñ∂' }}</span>
    </div>
    <div class="slider-content" *ngIf="expandedSections['image']">
      <div class="slider-row" *ngFor="let slider of getSlidersByGroup('image')">
        <label>{{ slider.label }}</label>
        <input type="range" [min]="slider.min" [max]="slider.max" [step]="slider.step"
               [(ngModel)]="slider.value" (input)="onSliderChange(slider)"/>
        <span class="value">{{ slider.value }}</span>
      </div>
    </div>
  </div>

  <div class="config-section">
    <div class="section-header clickable" (click)="toggleSection('edge')">
      <h4>üìè Detecci√≥n de Bordes</h4>
      <span class="toggle-icon">{{ expandedSections['edge'] ? '‚ñº' : '‚ñ∂' }}</span>
    </div>
    <div class="slider-content" *ngIf="expandedSections['edge']">
      <div class="slider-row" *ngFor="let slider of getSlidersByGroup('edge')">
        <label>{{ slider.label }}</label>
        <input type="range" [min]="slider.min" [max]="slider.max" [step]="slider.step"
               [(ngModel)]="slider.value" (input)="onSliderChange(slider)"/>
        <span class="value">{{ slider.value }}</span>
      </div>
    </div>
  </div>

  <div class="config-section">
    <div class="section-header clickable" (click)="toggleSection('adaptive')">
      <h4>üí° Iluminaci√≥n Adaptativa</h4>
      <span class="toggle-icon">{{ expandedSections['adaptive'] ? '‚ñº' : '‚ñ∂' }}</span>
    </div>
    <div class="slider-content" *ngIf="expandedSections['adaptive']">
      <div class="toggle-row">
        <label>CLAHE</label>
        <button class="toggle-btn" [class.active]="useClahe" (click)="toggleClahe()">
          {{ useClahe ? 'ON' : 'OFF' }}
        </button>
      </div>
      <div class="toggle-row">
        <label>Blanco Adaptativo</label>
        <button class="toggle-btn" [class.active]="useAdaptiveWhite" (click)="toggleAdaptiveWhite()">
          {{ useAdaptiveWhite ? 'ON' : 'OFF' }}
        </button>
      </div>
      <div class="toggle-row">
        <label>Fallback Gradiente</label>
        <button class="toggle-btn" [class.active]="useGradientFallback" (click)="toggleGradientFallback()">
          {{ useGradientFallback ? 'ON' : 'OFF' }}
        </button>
      </div>
      <div class="slider-row" *ngFor="let slider of getSlidersByGroup('adaptive')">
        <label>{{ slider.label }}</label>
        <input type="range" [min]="slider.min" [max]="slider.max" [step]="slider.step"
               [(ngModel)]="slider.value" (input)="onSliderChange(slider)"/>
        <span class="value">{{ slider.value }}</span>
      </div>
    </div>
  </div>

  <div class="actions">
    <button class="btn-apply" (click)="sendConfig()">Aplicar Configuraci√≥n</button>
  </div>
</div>
